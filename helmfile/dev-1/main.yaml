# helmfile.yaml
repositories:
  - name: istio
    url: https://istio-release.storage.googleapis.com/charts
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: jetstack
    url: https://charts.jetstack.io

releases:
  # Istio Base
- name: istio-base
  namespace: istio-system
  chart: istio/base
  version: 1.17.2  # replace with the desired version
  values: []

# Istiod (Istio control plane)
- name: istiod
  namespace: istio-system
  chart: istio/istiod
  version: 1.17.2  # replace with the desired version
  values: []

# Istio Ingress Gateway
- name: istio-ingress
  namespace: istio-system
  chart: istio/gateway
  version: 1.17.2  # replace with the desired version
  values: []

# ExternalDNS
- name: external-dns
  namespace: kube-system
  chart: bitnami/external-dns
  version: 0.13.1  # replace with the desired version
  values:
    - provider: azure
      azure:
        resourceGroup: YourResourceGroupName
        subscriptionId: YourSubscriptionID
        tenantId: YourTenantID
      txtOwnerId: aks-externaldns
      domainFilters:
        - yourdomain.com
      extraArgs:
        - --azure-secret-name=external-dns-azure-credentials
        - --azure-secret-namespace=kube-system

# Cert-Manager
- name: cert-manager
  namespace: cert-manager
  chart: jetstack/cert-manager
  version: v1.11.0  # replace with the desired version
  values:
    - installCRDs: true

# Post-Installation: ClusterIssuer for Cert-Manager (applied separately)

helmDefaults:
  wait: true
  timeout: 600

templates:
  - name: letsencrypt-prod
    namespace: cert-manager
    chart: cert-manager/clusterissuer
    version: v1.11.0
    values:
      - |
        apiVersion: cert-manager.io/v1
        kind: ClusterIssuer
        metadata:
          name: letsencrypt-prod
        spec:
          acme:
            server: https://acme-v02.api.letsencrypt.org/directory
            email: your-email@example.com
            privateKeySecretRef:
              name: letsencrypt-prod
            solvers:
              - http01:
                  ingress:
                    class: istio
